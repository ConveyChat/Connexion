<!DOCTYPE html>

<html>
  <head>
    <title>MetaMask Messaging</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/@dfuse/client"></script>
    <script src="dfuse.js"></script>
    <script src="./decoder/decodeBundle.js"></script>
  </head>

  <body>
    <section class="hero is-metamask-orange">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">
            Welcome
          </h1>
          <h2 class="subtitle"></h2>
        </div>
      </div>
    </section>
    <br />
    <div class="container">
      <div class="has-text-centered">
        <button class="button install is-dark">
          Install Metamask Plugin
        </button>
        <button class="button link">Login with Metamask</button>
      </div>
      <br /><br /><br />
      <div class="columns">
        <div class="column">
          <p class="title has-text-centered">Send:</p>
          <div class="box has-background-white-bis">
            <div class="field">
              <label class="label">Receiver Address: </label>
              <div class="control">
                <input class="input" type="text" placeholder="0x..." />
              </div>
            </div>
            <div class="field">
              <label class="label">Message: </label>
              <div class="control">
                <textarea class="textarea" placeholder=""></textarea>
              </div>
            </div>
            <div class="control has-text-centered">
              <button class="button is-dark sendbutton is-fullwidth">Send!</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script src="bundle.js"></script>

  <script>
    let ethAddress, index, pluginApi;

    const snapUrl = new URL('package.json', window.location.href).toString();
    const snapId = `wallet_plugin_${snapUrl}`;

    const connectButton = document.querySelector('button.install');
    const loginButton = document.querySelector('button.link');
    const addressH2 = document.querySelector('h2.subtitle');
    const messagesDiv = document.querySelector('div.messages');
    const sendButton = document.querySelector('button.sendbutton');

    connectButton.addEventListener('click', install);
    loginButton.addEventListener('click', link);
    sendButton.addEventListener('click', sendMSG);

    async function install() {
      await ethereum.send({
        method: 'wallet_requestPermissions',
        params: [
          {
            [snapId]: {},
            eth_accounts: {}
          }
        ]
      });
      connectButton.style.display = 'none';
    }

    async function link() {
      try {
        const response = await ethereum.send('eth_accounts');
        console.log(response);
        ethAddress = response[0];
        addressH2.innerHTML = ethAddress;
        loginButton.style.display = 'none';
        connectButton.style.display = 'none'; // This is needed for cases where the user already installed the plugin and just clicks Login
        console.log('Received ETH Account');
        await requestIndex();
      } catch (err) {
        console.error(err);
        alert('Problem happened: ' + err.message || err);
      }
    }

    async function requestIndex() {
      try {
        index = await ethereum.requestIndex();
        pluginApi = await index.getPluginApi(snapUrl.toString());
        console.log('Received Snap API');
      } catch (e) {
        console.error(e);
        console.error('Problem requesting index.');
      }
    }

    async function receiveMessage(msg) {
      try {
        const response = await pluginApi.registerNewMessage(msg);
        console.log(response);
      } catch (err) {
        console.error(err);
        alert('Problem happened: ' + err.message || err);
      }
    }
    async function listen() {
      try {
        await pluginApi.on('newMessage', response => {
          wallet.send({
            method: 'alert',
            params: [`You have a new message from ${response.msg.sender}`]
          });
        });
      } catch (err) {
        console.error(err);
        alert('Problem happened: ' + err.message || err);
      }
    }

    async function sendMSG() {

      const ensName = document.querySelector("input.input").value;
      const msg = document.querySelector("textarea.textarea").value;
      bundle.send(ethAddress, ensName, msg);
    }
  </script>
</html>
